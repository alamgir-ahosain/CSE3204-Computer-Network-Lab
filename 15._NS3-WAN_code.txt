#include "ns3/applications-module.h"
#include "ns3/core-module.h"
#include "ns3/internet-module.h"
#include "ns3/network-module.h"
#include "ns3/point-to-point-module.h"
#include "ns3/netanim-module.h"

using namespace ns3;
NS_LOG_COMPONENT_DEFINE("WANExample");

int main(int argc, char* argv[]) {
    CommandLine cmd;
    cmd.Parse(argc, argv);

    // Set time resolution
    Time::SetResolution(Time::NS);
    LogComponentEnable("UdpEchoClientApplication", LOG_LEVEL_INFO);
    LogComponentEnable("UdpEchoServerApplication", LOG_LEVEL_INFO);

    // Create nodes for two LANs and routers
    NodeContainer lan1Nodes, lan2Nodes, routers;
    lan1Nodes.Create(2); // PCs in LAN 1
    lan2Nodes.Create(2); // PCs in LAN 2
    routers.Create(2);   // Routers: r0 and r1

    // Point-to-Point Helper for LAN 1 (n0 to r0, n1 to r0)
    PointToPointHelper lanHelper;
    lanHelper.SetDeviceAttribute("DataRate", StringValue("50Mbps"));
    lanHelper.SetChannelAttribute("Delay", StringValue("10ms"));

    NetDeviceContainer lan1Devices;
    lan1Devices.Add(lanHelper.Install(lan1Nodes.Get(0), routers.Get(0))); // n0 to r0
    lan1Devices.Add(lanHelper.Install(lan1Nodes.Get(1), routers.Get(0))); // n1 to r0

    // Point-to-Point Helper for LAN 2 (n2 to r1, n3 to r1)
    NetDeviceContainer lan2Devices;
    lan2Devices.Add(lanHelper.Install(lan2Nodes.Get(0), routers.Get(1))); // n2 to r1
    lan2Devices.Add(lanHelper.Install(lan2Nodes.Get(1), routers.Get(1))); // n3 to r1

    // Point-to-Point Helper for inter-router link (r0 to r1)
    PointToPointHelper routerLinkHelper;
    routerLinkHelper.SetDeviceAttribute("DataRate", StringValue("100Mbps"));
    routerLinkHelper.SetChannelAttribute("Delay", StringValue("20ms"));

    NetDeviceContainer routerDevices;
    routerDevices.Add(routerLinkHelper.Install(routers.Get(0), routers.Get(1))); // r0 to r1

    // Install Internet Stack on all nodes and routers
    InternetStackHelper stack;
    stack.Install(lan1Nodes);
    stack.Install(lan2Nodes);
    stack.Install(routers);

    // Assign IP addresses to all devices
    Ipv4AddressHelper address;

    // Assign IP to LAN 1
    address.SetBase("10.1.1.0", "255.255.255.0");
    Ipv4InterfaceContainer lan1Interfaces = address.Assign(lan1Devices);

    // Assign IP to LAN 2
    address.SetBase("10.1.2.0", "255.255.255.0");
    Ipv4InterfaceContainer lan2Interfaces = address.Assign(lan2Devices);

    // Assign IP to inter-router link
    address.SetBase("10.1.3.0", "255.255.255.0");
    Ipv4InterfaceContainer routerInterfaces = address.Assign(routerDevices);

    // Create UDP Echo Server on node n0 in LAN 1 (PC in LAN 1)
    UdpEchoServerHelper echoServer(8080); // Port 8080
    ApplicationContainer serverApps = echoServer.Install(lan1Nodes.Get(0)); // n0 in LAN 1
    serverApps.Start(Seconds(1.0));
    serverApps.Stop(Seconds(20.0));

    // Create UDP Echo Client on node n3 in LAN 2 for continuous packet transfer
    UdpEchoClientHelper echoClient(lan1Interfaces.GetAddress(0), 8080);
    echoClient.SetAttribute("MaxPackets", UintegerValue(100));
    echoClient.SetAttribute("Interval", TimeValue(Seconds(0.1)));
    echoClient.SetAttribute("PacketSize", UintegerValue(512));

    ApplicationContainer clientApps = echoClient.Install(lan2Nodes.Get(1)); // n3 in LAN 2
    clientApps.Start(Seconds(2.0)); // Start after 2 seconds
    clientApps.Stop(Seconds(20.0)); // Stop after 20 seconds

    // Enable ASCII trace for debugging
    AsciiTraceHelper ascii;
    lanHelper.EnableAsciiAll(ascii.CreateFileStream("wan.tr"));

    // Enable NetAnim for visualization
    AnimationInterface anim("wan.xml");
    // Set node positions for visualization
    anim.SetConstantPosition(lan1Nodes.Get(0), 10.0, 10.0); // PC1 (n0)
    anim.SetConstantPosition(lan1Nodes.Get(1), 10.0, 50.0); // PC2 (n1)
    anim.SetConstantPosition(lan2Nodes.Get(0), 80.0, 10.0); // PC3 (n2)
    anim.SetConstantPosition(lan2Nodes.Get(1), 80.0, 50.0); // PC4 (n3)
    anim.SetConstantPosition(routers.Get(0), 20.0, 30.0);    // Router r0
    anim.SetConstantPosition(routers.Get(1), 70.0, 30.0);    // Router r1
    // Label nodes in the animation
    anim.UpdateNodeDescription(lan1Nodes.Get(0), "PC 1 (n0)");
    anim.UpdateNodeDescription(lan1Nodes.Get(1), "PC 2 (n1)");
    anim.UpdateNodeDescription(lan2Nodes.Get(0), "PC 3 (n2)");
    anim.UpdateNodeDescription(lan2Nodes.Get(1), "PC 4 (n3)");
    anim.UpdateNodeDescription(routers.Get(0), "Router r0");
    anim.UpdateNodeDescription(routers.Get(1), "Router r1");

    // Start the simulation
    Simulator::Run();
    Simulator::Destroy();
    return 0;
}
